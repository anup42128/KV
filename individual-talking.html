<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Individual Talking - Class Voice</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="styles.css"><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script src="supabase-config.js"></script><script src="session-manager.js"></script><style> .page-container { min-height: 100vh; padding-top: 100px; padding-bottom: 50px; } .back-button { position: fixed; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 8px 20px; border-radius: 25px; font-size: 0.9rem; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; gap: 8px; z-index: 1000; } .back-button:hover { background: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.5); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); } .back-button:active { transform: translateY(0); } .top-header { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px 0; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.2); } .header-content { max-width: 1400px; margin: 0 auto; padding: 0 20px; text-align: center; } .header-title { font-size: 1.5rem; font-weight: 600; color: var(--white); text-transform: uppercase; letter-spacing: 1.5px; margin: 0; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); } .header-subtitle { font-size: 0.85rem; color: rgba(255, 255, 255, 0.85); text-align: center; margin-top: 3px; font-weight: 400; letter-spacing: 0.3px; } .search-container { max-width: 500px; margin: 100px auto 0; padding: 0 20px; } .search-bar { width: 100%; padding: 12px 20px; border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; font-family: 'Poppins', sans-serif; font-size: 1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; } .search-bar::placeholder { color: rgba(255, 255, 255, 0.7); } .search-bar:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); } .search-separator { height: 1.8px; background: rgba(255, 255, 255, 0.2); margin: 20px auto; max-width: 1200px; border-radius: 1px; } .user-container { max-width: 1200px; margin: 30px auto 0; padding: 0 20px; } .user-card-horizontal { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 25px; min-height: 120px; margin-bottom: 20px; } .user-card-horizontal:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); background: rgba(255, 255, 255, 0.15); } .user-avatar { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue), var(--accent-orange)); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 1.5rem; flex-shrink: 0; } .user-info { flex: 1; } .user-name { font-size: 1.4rem; font-weight: 600; color: var(--white); margin-bottom: 8px; } .user-details { display: flex; gap: 20px; margin-top: 10px; } .user-detail-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); } .user-actions { display: flex; gap: 15px; } .action-btn { padding: 10px 20px; border-radius: 25px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; border: none; } .message-btn { background: var(--accent-orange); color: white; box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); } .message-btn:hover { background: #ea580c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); } .profile-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); } .profile-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); } .user-card-horizontal.hidden { display: none; } .no-results { text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 1.2rem; padding: 40px 20px; display: none; } .initial-message { text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 1.2rem; padding: 40px 20px; } .chat-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e, #16213e); z-index: 2000; padding: 0; } .chat-content { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; } .chat-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); } .chat-back-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 15px; border-radius: 20px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; } .chat-back-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); } .chat-user-info { flex: 1; } .chat-user-name { font-size: 1.4rem; font-weight: 600; color: var(--white); margin-bottom: 5px; } .chat-user-email { font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); } .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none; } .chat-messages::-webkit-scrollbar { display: none; } .message { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-family: 'Poppins', sans-serif; font-size: 0.95rem; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; word-break: break-word; white-space: normal; overflow-wrap: break-word; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .received-message { background: rgba(255, 255, 255, 0.15); border-bottom-left-radius: 5px; align-self: flex-start; color: white; } .sent-message { background: var(--accent-orange); border-bottom-right-radius: 5px; align-self: flex-end; color: white; } .message-time { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; text-align: right; } .chat-input-container { padding: 20px; display: flex; gap: 10px; border-top: 1px solid rgba(255, 255, 255, 0.2); } .chat-input { flex: 1; padding: 12px 20px; border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; font-family: 'Poppins', sans-serif; font-size: 1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); min-height: 50px; max-height: 150px; height: auto; resize: none; scrollbar-width: none; -ms-overflow-style: none; overflow-y: auto; overflow-x: hidden; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; } .chat-input::-webkit-scrollbar { display: none; } .chat-input::placeholder { color: rgba(255, 255, 255, 0.7); } .chat-input:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); background: rgba(255, 255, 255, 0.15); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); } .send-btn { background: var(--accent-orange); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); align-self: flex-end; margin-bottom: 5px; } .send-btn:hover { background: #ea580c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); } .send-btn:disabled { background: rgba(255, 255, 255, 0.2); transform: none; box-shadow: none; cursor: not-allowed; } .send-btn.sending { opacity: 0.7; cursor: not-allowed; } .favorite-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; margin-right: 10px; } .favorite-btn .star { font-size: 24px; color: rgba(255, 255, 255, 0.5); transition: all 0.3s ease; } .favorite-btn:hover .star { color: rgba(255, 255, 255, 0.8); transform: scale(1.1); } .favorite-btn.active .star { color: #FFD700; text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; animation: glow 1.5s infinite alternate; } @keyframes glow { from { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700; } to { text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700, 0 0 40px #FFD700; } } #favoriteUsersContainer h3 { color: white; text-align: center; margin-bottom: 20px; font-size: 1.5rem; font-weight: 600; } .search-separator + .search-separator { margin-top: 20px; } @media (max-width: 768px) { .top-header { padding: 12px 0; } .header-content { padding: 0 15px; } .header-title { font-size: 1.2rem; letter-spacing: 1px; } .header-subtitle { font-size: 0.75rem; } .back-button { top: 15px; left: 15px; padding: 6px 15px; font-size: 0.8rem; } .search-container { margin: 80px auto 0; padding: 0 15px; } .search-bar { padding: 10px 15px; font-size: 0.95rem; } .user-container { padding: 0 15px; margin: 20px auto 0; } .user-card-horizontal { padding: 20px; gap: 15px; min-height: 100px; margin-bottom: 15px; } .user-avatar { width: 60px; height: 60px; font-size: 1.3rem; } .user-name { font-size: 1.2rem; margin-bottom: 5px; } .user-details { flex-direction: column; gap: 8px; margin-top: 8px; } .user-detail-item { font-size: 0.85rem; gap: 6px; } .user-actions { flex-direction: column; gap: 10px; } .action-btn { padding: 8px 15px; font-size: 0.85rem; width: 100%; justify-content: center; } .no-results, .initial-message { font-size: 1rem; padding: 30px 15px; } .chat-container { padding: 0; } .chat-header { padding: 15px; } .chat-user-name { font-size: 1.2rem; } .message { max-width: 85%; font-size: 0.9rem; padding: 10px 15px; } .chat-input { padding: 10px 15px; font-size: 0.95rem; } .send-btn { padding: 10px 20px; font-size: 0.85rem; } } @media (max-width: 480px) { .top-header { padding: 10px 0; } .header-title { font-size: 1rem; letter-spacing: 0.5px; } .header-subtitle { font-size: 0.7rem; margin-top: 2px; } .back-button { top: 12px; left: 12px; padding: 5px 12px; font-size: 0.75rem; border-width: 1px; } .search-container { margin: 70px auto 0; padding: 0 12px; } .search-bar { padding: 8px 12px; font-size: 0.9rem; } .user-container { padding: 0 12px; margin: 15px auto 0; } .user-card-horizontal { padding: 15px; gap: 12px; flex-direction: column; text-align: center; min-height: auto; } .user-avatar { width: 50px; height: 50px; font-size: 1.2rem; margin: 0 auto; } .user-name { font-size: 1.1rem; margin-bottom: 10px; } .user-details { align-items: center; gap: 10px; } .user-detail-item { font-size: 0.8rem; gap: 5px; } .user-actions { flex-direction: row; width: 100%; margin-top: 15px; } .action-btn { padding: 8px 12px; font-size: 0.8rem; width: auto; flex: 1; } .no-results, .initial-message { font-size: 0.95rem; padding: 25px 12px; } .chat-container { padding: 0; } .chat-header { padding: 12px; flex-direction: row; align-items: center; text-align: left; gap: 10px; } .chat-user-info { display: flex; flex-direction: column; align-items: flex-start; } .chat-user-name { font-size: 1.1rem; margin-bottom: 3px; } .chat-user-email { font-size: 0.8rem; } .chat-input-container { padding: 12px; flex-direction: row; gap: 8px; align-items: center; } .chat-input { padding: 8px 12px; min-height: 40px; font-size: 0.9rem; flex: 1; } .send-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0; position: relative; flex-shrink: 0; background: var(--accent-orange); color: white; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); } .send-btn::before { content: "‚û§"; font-size: 16px; transform: rotate(0deg); color: white; } .send-btn:hover { background: #ea580c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); } .send-btn:disabled { background: rgba(255, 255, 255, 0.2); transform: none; box-shadow: none; cursor: not-allowed; } .message { max-width: 90%; font-size: 0.85rem; padding: 8px 12px; } } </style></head><body><div class="bg-animation"><div class="floating-shape shape1"></div><div class="floating-shape shape2"></div><div class="floating-shape shape3"></div><div class="floating-shape shape4"></div><div class="floating-shape shape5"></div></div><header class="top-header"><div class="header-content"><h1 class="header-title">Individual Talking</h1><p class="header-subtitle">Start a private conversation</p></div></header><div class="search-container"><input type="text" id="userSearch" class="search-bar" placeholder="Search for users to talk to..."></div><div class="search-separator"></div><div class="user-container" id="starredUsersContainer"></div><div class="user-container" id="userContainer"><div class="initial-message" id="initialMessage"> Start typing to search for users... </div><div class="no-results" id="noResultsMessage"> No users found matching your search. </div></div><div id="chatInterface" class="chat-container"><div class="chat-content"><div class="chat-header"><button class="chat-back-btn" onclick="backToSearch()">‚Üê Back</button><div class="chat-user-info"><div class="chat-user-name" id="chatUserName">User Name</div><div class="chat-user-email" id="chatUserEmail">uni.classvoice@gmail.com</div></div></div><div class="chat-messages" id="chatMessages"></div><div class="chat-input-container"><textarea class="chat-input" id="messageInput" placeholder="Type your message..."></textarea><button class="send-btn" id="sendButton" onclick="sendMessage()">Send</button></div></div></div><button class="back-button" onclick="goBack()"><span class="btn-icon">‚Üê</span><span class="btn-text">Back</span></button><script> let allUsers = []; let currentUserId = null; let currentChatPartner = null; let messagesSubscription = null; let unreadMessagesSubscription = null; let favoriteUsers = []; let unreadMessageCounts = new Map(); function goBack() { if (window.history.length > 1) { window.history.back(); } else { window.location.href = 'feedbacks.html'; } } async function showChatInterface(userName, userId) { console.log(`üí¨ Showing chat interface for ${userName} (${userId})`); document.querySelector('.top-header').style.display = 'none'; document.querySelector('.search-container').style.display = 'none'; document.querySelector('.search-separator').style.display = 'none'; document.getElementById('userContainer').style.display = 'none'; document.querySelector('.back-button').style.display = 'none'; document.getElementById('chatInterface').style.display = 'flex'; document.getElementById('chatUserName').textContent = userName; const previousChatPartner = currentChatPartner; currentChatPartner = { id: userId, name: userName }; console.log('üë• Chat partner changed:', { previous: previousChatPartner, current: currentChatPartner }); const chatMessages = document.getElementById('chatMessages'); chatMessages.innerHTML = ''; clearDisplayedMessages(); await loadChatHistory(); subscribeToMessages(); chatMessages.scrollTop = chatMessages.scrollHeight; document.getElementById('messageInput').focus(); if (currentChatPartner) { markMessagesAsRead(currentChatPartner.id, currentUserId); } } function backToSearch() { if (messagesSubscription) { DatabaseHelper.unsubscribeFromMessages(messagesSubscription); messagesSubscription = null; } clearDisplayedMessages(); document.getElementById('chatInterface').style.display = 'none'; document.querySelector('.top-header').style.display = 'block'; document.querySelector('.search-container').style.display = 'block'; document.querySelector('.search-separator').style.display = 'block'; document.getElementById('userContainer').style.display = 'block'; document.querySelector('.back-button').style.display = 'flex'; } const displayedMessageIds = new Set(); function addMessage(messageData, isSent) { console.log('‚ûï Adding message to chat:', { messageData, isSent }); if (messageData.id && displayedMessageIds.has(messageData.id)) { console.log('‚ö†Ô∏è Message already displayed, skipping:', messageData.id); return; } const chatMessages = document.getElementById('chatMessages'); const messageDiv = document.createElement('div'); messageDiv.className = isSent ? 'message sent-message' : 'message received-message'; const timestamp = new Date(messageData.created_at); const timeString = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0'); messageDiv.innerHTML = ` ${messageData.content} <div class="message-time">${timeString}</div> `; chatMessages.appendChild(messageDiv); if (messageData.id) { displayedMessageIds.add(messageData.id); } chatMessages.scrollTop = chatMessages.scrollHeight; console.log('‚úÖ Message added to chat UI'); } function clearDisplayedMessages() { displayedMessageIds.clear(); console.log('üßπ Cleared displayed message IDs'); } async function ensureAuthentication() { try { if (!supabase) { console.error('Supabase not initialized'); return false; } const { data: { session } } = await supabase.auth.getSession(); if (session) { console.log('‚úÖ User is authenticated with Supabase'); return true; } const currentUser = SessionManager.getCurrentUser(); if (currentUser && currentUser.username) { console.log('‚úÖ User is authenticated with custom session'); console.log('‚ö†Ô∏è Using custom session authentication (not Supabase Auth)'); return true; } console.error('‚ùå User not authenticated'); return false; } catch (error) { console.error('‚ùå Authentication check failed:', error); return false; } } let isSendingMessage = false; async function sendMessage() { if (isSendingMessage) { console.log('Message sending in progress, ignoring duplicate request'); return; } const messageInput = document.getElementById('messageInput'); const message = messageInput.value.trim(); const sendButton = document.getElementById('sendButton'); if (message && currentUserId && currentChatPartner) { isSendingMessage = true; const originalButtonText = sendButton.innerHTML; sendButton.innerHTML = 'Sending...'; sendButton.disabled = true; sendButton.classList.add('sending'); try { const isAuthenticated = await ensureAuthentication(); if (!isAuthenticated) { alert('You must be logged in to send messages'); return; } if (!currentUserId) { alert('Unable to verify your identity. Please refresh the page and try again.'); return; } messageInput.value = ''; messageInput.style.height = 'auto'; messageInput.style.height = '50px'; const messageData = { senderId: currentUserId, receiverId: currentChatPartner.id, content: message }; const result = await DatabaseHelper.sendMessage(messageData); if (!result.success) { console.error('Failed to send message:', result.error); alert('Failed to send message: ' + result.error); } } catch (error) { console.error('Error sending message:', error); alert('Error sending message: ' + error.message); } finally { isSendingMessage = false; sendButton.innerHTML = originalButtonText; sendButton.disabled = false; sendButton.classList.remove('sending'); } } } function subscribeToMessages() { if (!currentUserId || !currentChatPartner) { console.log('‚ö†Ô∏è Cannot subscribe to messages: missing user IDs'); return; } if (messagesSubscription) { console.log('üîÑ Unsubscribing from previous message subscription'); DatabaseHelper.unsubscribeFromMessages(messagesSubscription); messagesSubscription = null; } console.log(`üì° Setting up real-time subscription for conversation between ${currentUserId} and ${currentChatPartner.id}`); messagesSubscription = DatabaseHelper.subscribeToMessages( currentUserId, currentChatPartner.id, (newMessage) => { console.log('üì• Received new message:', newMessage); const isSent = newMessage.sender_id === currentUserId; addMessage(newMessage, isSent); } ); if (messagesSubscription) { console.log('‚úÖ Real-time message subscription established'); } else { console.error('‚ùå Failed to establish real-time message subscription'); } } async function loadChatHistory() { if (!currentUserId || !currentChatPartner) return; try { console.log(`üìö Loading chat history between ${currentUserId} and ${currentChatPartner.id}`); const result = await DatabaseHelper.getMessagesBetweenUsers(currentUserId, currentChatPartner.id); if (result.success) { const chatMessages = document.getElementById('chatMessages'); chatMessages.innerHTML = ''; result.messages.forEach(message => { const isSent = message.sender_id === currentUserId; addMessage(message, isSent); }); console.log(`‚úÖ Loaded ${result.messages.length} messages`); } else { console.error('Failed to load chat history:', result.error); } } catch (error) { console.error('Error loading chat history:', error); } } function autoResizeTextarea() { const textarea = document.getElementById('messageInput'); textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px'; } function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; } const debouncedSendMessage = debounce(sendMessage, 300); document.addEventListener('DOMContentLoaded', function() { const messageInput = document.getElementById('messageInput'); messageInput.addEventListener('input', autoResizeTextarea); messageInput.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); debouncedSendMessage(); } }); const sendButton = document.getElementById('sendButton'); sendButton.addEventListener('click', debouncedSendMessage); }); document.addEventListener('DOMContentLoaded', function() { const elements = document.querySelectorAll('.content-container'); elements.forEach((element, index) => { setTimeout(() => { element.style.opacity = '0'; element.style.transform = 'translateY(30px)'; element.style.transition = 'all 0.8s ease'; setTimeout(() => { element.style.opacity = '1'; element.style.transform = 'translateY(0)'; }, 100); }, index * 200); }); }); document.addEventListener('DOMContentLoaded', async function() { if (typeof initializeSupabase === 'function') { initializeSupabase(); } await getCurrentUserId(); await loadUsers(); await initializeUnreadMessageCounts(); const searchInput = document.getElementById('userSearch'); searchInput.addEventListener('input', filterUsers); subscribeToUnreadMessages(); displayStarredUsers(); document.getElementById('initialMessage').style.display = 'block'; }); async function getCurrentUserId() { try { if (!supabase) { console.error('Supabase not initialized'); return; } const { data: { session } } = await supabase.auth.getSession(); if (!session) { console.error('User not authenticated'); const currentUser = SessionManager.getCurrentUser(); if (currentUser.sessionToken) { await supabase.auth.setSession({ access_token: currentUser.sessionToken, refresh_token: '' }); } } const currentUser = SessionManager.getCurrentUser(); if (!currentUser.username) { console.error('No current user found'); return; } const { data: user, error } = await supabase .from('users') .select('id') .eq('username', currentUser.username) .single(); if (error) { console.error('Error fetching current user:', error); return; } currentUserId = user.id; console.log('Current user ID:', currentUserId); } catch (error) { console.error('Error getting current user ID:', error); } } async function loadUsers() { try { if (!supabase) { console.error('Supabase not initialized'); return; } const { data: users, error } = await supabase .from('users') .select('id, username, full_name, created_at') .order('full_name'); if (error) { console.error('Error fetching users:', error); return; } allUsers = users || []; loadFavoriteUsersWithoutDisplay(); } catch (error) { console.error('Error loading users:', error); } } async function initializeUnreadMessageCounts() { if (!currentUserId || !allUsers || allUsers.length === 0) return; try { console.log('üì¨ Initializing unread message counts for all users'); const result = await DatabaseHelper.getAllUnreadMessageCounts(currentUserId); if (result.success) { console.log(`üì¨ Found ${Object.keys(result.counts).length} users with unread messages`); for (const [senderId, count] of Object.entries(result.counts)) { unreadMessageCounts.set(senderId, count); } setTimeout(() => { for (const [senderId, count] of Object.entries(result.counts)) { updateUnreadBadge(senderId, count); } }, 10); } console.log('‚úÖ Unread message counts initialized'); } catch (error) { console.error('‚ùå Error initializing unread message counts:', error); } } function loadFavoriteUsers() { try { const currentUser = SessionManager.getCurrentUser(); const currentUserIdentifier = currentUser && currentUser.username ? currentUser.username : 'default'; const favoritesKey = `favoriteUsers_${currentUserIdentifier}`; const favorites = localStorage.getItem(favoritesKey); if (favorites) { favoriteUsers = JSON.parse(favorites); } displayStarredUsers(); } catch (error) { console.error('Error loading favorite users:', error); favoriteUsers = []; } } function loadFavoriteUsersWithoutDisplay() { try { const currentUser = SessionManager.getCurrentUser(); const currentUserIdentifier = currentUser && currentUser.username ? currentUser.username : 'default'; const favoritesKey = `favoriteUsers_${currentUserIdentifier}`; const favorites = localStorage.getItem(favoritesKey); if (favorites) { favoriteUsers = JSON.parse(favorites); } } catch (error) { console.error('Error loading favorite users:', error); favoriteUsers = []; } } function saveFavoriteUsers() { try { const currentUser = SessionManager.getCurrentUser(); const currentUserIdentifier = currentUser && currentUser.username ? currentUser.username : 'default'; const favoritesKey = `favoriteUsers_${currentUserIdentifier}`; localStorage.setItem(favoritesKey, JSON.stringify(favoriteUsers)); } catch (error) { console.error('Error saving favorite users:', error); } } function displayStarredUsers() { const starredContainer = document.getElementById('starredUsersContainer'); starredContainer.innerHTML = ''; if (favoriteUsers.length > 0) { favoriteUsers.forEach(userId => { const user = allUsers.find(u => u.id === userId); if (user) { const userCard = createUserCard(user); starredContainer.appendChild(userCard); } }); } } function filterUsers() { const searchTerm = document.getElementById('userSearch').value.toLowerCase().trim(); const userContainer = document.getElementById('userContainer'); const starredContainer = document.getElementById('starredUsersContainer'); const initialMessage = document.getElementById('initialMessage'); const noResultsMessage = document.getElementById('noResultsMessage'); if (searchTerm === '') { starredContainer.style.display = 'block'; initialMessage.style.display = 'block'; noResultsMessage.style.display = 'none'; userContainer.innerHTML = ''; userContainer.appendChild(initialMessage); userContainer.appendChild(noResultsMessage); return; } else { starredContainer.style.display = 'none'; } initialMessage.style.display = 'none'; const filteredUsers = allUsers.filter(user => { const fullName = (user.full_name || user.username).toLowerCase(); const username = user.username.toLowerCase(); return fullName.startsWith(searchTerm) || username.startsWith(searchTerm); }); filteredUsers.sort((a, b) => { const nameA = a.full_name || a.username; const nameB = b.full_name || b.username; return nameA.localeCompare(nameB); }); userContainer.innerHTML = ''; userContainer.appendChild(initialMessage); userContainer.appendChild(noResultsMessage); if (filteredUsers.length === 0) { noResultsMessage.style.display = 'block'; } else { noResultsMessage.style.display = 'none'; filteredUsers.forEach(user => { const userCard = createUserCard(user); userContainer.appendChild(userCard); }); } } function createUserCard(user) { const userCard = document.createElement('div'); userCard.className = 'user-card-horizontal'; userCard.dataset.username = user.username; userCard.dataset.fullName = user.full_name || user.username; userCard.dataset.userId = user.id; const firstLetter = (user.full_name || user.username).charAt(0).toUpperCase(); const joinDate = new Date(user.created_at); const formattedDate = joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }); const isFavorited = favoriteUsers.includes(user.id); userCard.innerHTML = ` <div class="user-avatar">${firstLetter}</div><div class="user-info"><div class="user-name">${user.full_name || user.username}</div><div class="user-details"><div class="user-detail-item"><span>üìß</span><span>uni.classvoice@gmail.com</span></div><div class="user-detail-item"><span>üìÖ</span><span>Joined ${formattedDate}</span></div></div></div><div class="user-actions"><button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite('${user.id}', this)"><div class="star">‚òÖ</div></button><button class="action-btn message-btn" onclick="showChatInterface('${user.full_name || user.username}', '${user.id}')"><span>üí¨</span><span>Message</span></button></div> `; const unreadCount = unreadMessageCounts.get(user.id) || 0; if (unreadCount > 0) { const badge = document.createElement('div'); badge.className = 'unread-badge'; badge.style.cssText = ` position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; `; const messageBtn = userCard.querySelector('.message-btn'); if (messageBtn) { messageBtn.style.position = 'relative'; messageBtn.appendChild(badge); badge.textContent = unreadCount > 9 ? '9+' : unreadCount; } } return userCard; } function toggleFavorite(userId, button) { button.classList.toggle('active'); const index = favoriteUsers.indexOf(userId); if (index > -1) { favoriteUsers.splice(index, 1); } else { favoriteUsers.push(userId); } saveFavoriteUsers(); displayStarredUsers(); } function testRealTimeMessage(messageText) { if (!currentChatPartner) { console.log('‚ö†Ô∏è No chat partner selected for testing'); return; } const testMessage = { content: messageText || "Test real-time message", created_at: new Date().toISOString(), sender_id: currentChatPartner.id, receiver_id: currentUserId }; console.log('üß™ Testing real-time message:', testMessage); addMessage(testMessage, false); } window.testRealTimeMessage = testRealTimeMessage; function subscribeToUnreadMessages() { if (!currentUserId) { console.log('‚ö†Ô∏è Cannot subscribe to unread messages: no current user'); return; } console.log(`üì° Subscribing to unread messages for user: ${currentUserId}`); unreadMessagesSubscription = DatabaseHelper.subscribeToUnreadMessages( currentUserId, (message) => { console.log('üì• Unread message notification received:', message); updateUnreadMessageCount(message.sender_id); } ); if (unreadMessagesSubscription) { console.log('‚úÖ Unread messages subscription established'); } else { console.error('‚ùå Failed to establish unread messages subscription'); } } async function updateUnreadMessageCount(senderId) { if (!currentUserId) return; try { const result = await DatabaseHelper.getUnreadMessageCountFromSender(senderId, currentUserId); if (result.success) { console.log(`üì¨ Unread message count from sender ${senderId}: ${result.count}`); unreadMessageCounts.set(senderId, result.count); updateUnreadBadge(senderId, result.count); } } catch (error) { console.error('‚ùå Error updating unread message count:', error); } } function updateUnreadBadge(userId, count) { console.log(`üîî Updating unread badge for user ${userId} with count ${count}`); const userCards = document.querySelectorAll(`.user-card-horizontal[data-user-id="${userId}"]`); userCards.forEach(card => { let badge = card.querySelector('.unread-badge'); if (count > 0) { if (!badge) { badge = document.createElement('div'); badge.className = 'unread-badge'; badge.style.cssText = ` position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; `; const messageBtn = card.querySelector('.message-btn'); if (messageBtn) { messageBtn.style.position = 'relative'; messageBtn.appendChild(badge); } } badge.textContent = count > 9 ? '9+' : count; badge.style.display = 'flex'; } else { if (badge) { badge.style.display = 'none'; } } }); } async function markMessagesAsRead(senderId, receiverId) { if (!senderId || !receiverId) return; try { console.log(`üì¨ Marking messages from ${senderId} to ${receiverId} as read`); const result = await DatabaseHelper.markMessagesAsRead(senderId, receiverId); if (result.success) { console.log('‚úÖ Messages marked as read'); unreadMessageCounts.set(senderId, 0); updateUnreadBadge(senderId, 0); } else { console.error('‚ùå Failed to mark messages as read:', result.error); } } catch (error) { console.error('‚ùå Error marking messages as read:', error); } } </script></body></html>
