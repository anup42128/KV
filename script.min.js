// PM SHRI KV Barrackpore Feedback Portal - Protected Script
(function(){
class ThemeManager{constructor(){this.init();}init(){this.applySystemTheme();this.watchSystemPreference();}applySystemTheme(){const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;const theme=prefersDark?'dark':'light';document.documentElement.setAttribute('data-theme',theme);}watchSystemPreference(){if(window.matchMedia){const mediaQuery=window.matchMedia('(prefers-color-scheme: dark)');mediaQuery.addListener((e)=>{const theme=e.matches?'dark':'light';document.documentElement.setAttribute('data-theme',theme);});}}}

class ModalManager{constructor(){this.overlay=document.getElementById('modalOverlay');this.signUpModal=document.getElementById('signUpModal');this.logInModal=document.getElementById('logInModal');this.init();}

init(){document.getElementById('signUpBtn')?.addEventListener('click',()=>this.openModal('signup'));document.getElementById('logInBtn')?.addEventListener('click',()=>this.openModal('login'));document.getElementById('closeSignUp')?.addEventListener('click',()=>this.closeModal());document.getElementById('closeLogIn')?.addEventListener('click',()=>this.closeModal());document.getElementById('switchToLogin')?.addEventListener('click',(e)=>{e.preventDefault();this.switchModal('login');});document.getElementById('switchToSignUp')?.addEventListener('click',(e)=>{e.preventDefault();this.switchModal('signup');});this.overlay?.addEventListener('click',(e)=>{if(e.target===this.overlay){this.closeModal();}});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.overlay?.classList.contains('active')){this.closeModal();}});document.getElementById('signUpForm')?.addEventListener('submit',(e)=>this.handleSignUp(e));document.getElementById('logInForm')?.addEventListener('submit',(e)=>this.handleLogIn(e));}

openModal(type){if(!this.overlay)return;this.signUpModal.style.display='none';this.logInModal.style.display='none';if(type==='signup'){this.signUpModal.style.display='block';}else{this.logInModal.style.display='block';}this.overlay.style.display='flex';requestAnimationFrame(()=>{this.overlay.classList.add('active');});document.body.style.overflow='hidden';}

closeModal(){if(!this.overlay)return;this.overlay.classList.remove('active');setTimeout(()=>{this.overlay.style.display='none';this.clearForms();},300);document.body.style.overflow='';}

switchModal(type){this.signUpModal.style.display='none';this.logInModal.style.display='none';if(type==='signup'){this.signUpModal.style.display='block';}else{this.logInModal.style.display='block';}this.clearForms();}

clearForms(){const forms=[document.getElementById('signUpForm'),document.getElementById('logInForm')];forms.forEach(form=>{if(form){form.reset();const inputs=form.querySelectorAll('.form-input');inputs.forEach(input=>{input.classList.remove('error','success');});}});}

async handleSignUp(e){e.preventDefault();const username=document.getElementById('signUpUsername').value;const password=document.getElementById('signUpPassword').value;const confirmPassword=document.getElementById('signUpConfirmPassword').value;if(!this.validateSignUp(username,password,confirmPassword)){return;}await this.processSignUp({username,password});}

async handleLogIn(e){e.preventDefault();const username=document.getElementById('logInUsername').value;const password=document.getElementById('logInPassword').value;if(!this.validateLogIn(username,password)){return;}await this.processLogIn({username,password});}

validateSignUp(username,password,confirmPassword){let isValid=true;const usernameInput=document.getElementById('signUpUsername');const passwordInput=document.getElementById('signUpPassword');const confirmPasswordInput=document.getElementById('signUpConfirmPassword');[usernameInput,passwordInput,confirmPasswordInput].forEach(input=>{input.classList.remove('error','success');const existingError=input.parentNode.querySelector('.error-message');if(existingError){existingError.remove();}});if(!username||username.trim().length===0){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username is required');isValid=false;}else if(username.length<3){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username must be at least 3 characters long');isValid=false;}else if(username.length>20){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username cannot exceed 20 characters');isValid=false;}else if(!/^[a-zA-Z0-9_]+$/.test(username)){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username can only contain letters, numbers, and underscores');isValid=false;}else if(/^[0-9_]/.test(username)){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username must start with a letter');isValid=false;}else{usernameInput.classList.add('success');}if(!password||password.length===0){passwordInput.classList.add('error');this.showFieldError(passwordInput,'🔒 Password is required');isValid=false;}else if(password.length<6){passwordInput.classList.add('error');this.showFieldError(passwordInput,'🔒 Password must be at least 6 characters long');isValid=false;}else if(password.length>100){passwordInput.classList.add('error');this.showFieldError(passwordInput,'🔒 Password cannot exceed 100 characters');isValid=false;}else{passwordInput.classList.add('success');}if(!confirmPassword||confirmPassword.length===0){confirmPasswordInput.classList.add('error');this.showFieldError(confirmPasswordInput,'🔑 Please confirm your password');isValid=false;}else if(password!==confirmPassword){confirmPasswordInput.classList.add('error');this.showFieldError(confirmPasswordInput,'🔑 Passwords do not match');isValid=false;}else if(confirmPassword.length>0){confirmPasswordInput.classList.add('success');}return isValid;}

validateLogIn(username,password){let isValid=true;const usernameInput=document.getElementById('logInUsername');const passwordInput=document.getElementById('logInPassword');[usernameInput,passwordInput].forEach(input=>{input.classList.remove('error','success');const existingError=input.parentNode.querySelector('.error-message');if(existingError){existingError.remove();}});if(!username||username.trim().length===0){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Please enter your username');isValid=false;}else if(username.length<3){usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 Username must be at least 3 characters');isValid=false;}else{usernameInput.classList.add('success');}if(!password||password.length===0){passwordInput.classList.add('error');this.showFieldError(passwordInput,'🔒 Please enter your password');isValid=false;}else if(password.length<6){passwordInput.classList.add('error');this.showFieldError(passwordInput,'🔒 Password must be at least 6 characters');isValid=false;}else{passwordInput.classList.add('success');}return isValid;}

showFieldError(input,message){const errorDiv=document.createElement('div');errorDiv.className='error-message';errorDiv.innerHTML=`<span style="color: #dc3545; font-size: 12px; margin-top: 5px; display: block;">${message}</span>`;input.parentNode.appendChild(errorDiv);input.style.animation='inputShake 0.3s ease-in-out';setTimeout(()=>{input.style.animation='';},300);}

async processSignUp(data){const submitBtn=document.querySelector('#signUpForm .form-btn');try{submitBtn.classList.add('loading');submitBtn.disabled=true;if(!window.DatabaseHelper){throw new Error('Database connection not available');}const result=await window.DatabaseHelper.createUser({username:data.username,password:data.password,user_type:'student'});submitBtn.classList.remove('loading');submitBtn.disabled=false;if(result.success){this.showMessage(result.message,'success');localStorage.setItem('currentUser',result.user.username);localStorage.setItem('userType',result.user.user_type);setTimeout(()=>{this.closeModal();window.location.href='dashboard.html';},1500);}else{if(result.error&&result.error.toLowerCase().includes('username already exists')){const usernameInput=document.getElementById('signUpUsername');usernameInput.classList.remove('success');usernameInput.classList.add('error');this.showFieldError(usernameInput,'👤 This username is already taken. Please choose another.');}else{this.showMessage(result.error||'Failed to create account. Please try again.','error');}}}catch(error){submitBtn.classList.remove('loading');submitBtn.disabled=false;this.showMessage('Failed to create account. Please try again.','error');}}

async processLogIn(data){const submitBtn=document.querySelector('#logInForm .form-btn');try{submitBtn.classList.add('loading');submitBtn.disabled=true;if(!window.DatabaseHelper){throw new Error('Database connection not available');}const result=await window.DatabaseHelper.authenticateUser(data.username,data.password);submitBtn.classList.remove('loading');submitBtn.disabled=false;if(result.success){this.showMessage(result.message,'success');localStorage.setItem('currentUser',result.user.username);localStorage.setItem('userType',result.user.user_type);localStorage.setItem('userId',result.user.id);if(window.DatabaseHelper.createSession){await window.DatabaseHelper.createSession(result.user.id);}setTimeout(()=>{this.closeModal();window.location.href='dashboard.html';},1500);}else{this.showMessage(result.error,'error');const form=document.getElementById('logInForm');form.style.animation='shake 0.5s ease-in-out';setTimeout(()=>{form.style.animation='';},500);}}catch(error){submitBtn.classList.remove('loading');submitBtn.disabled=false;this.showMessage('Login failed. Please check your connection and try again.','error');}}

showMessage(text,type='info'){const message=document.createElement('div');message.className=`modal-message modal-message-${type}`;message.innerHTML=`<span class="message-icon">${type==='success'?'✅':type==='error'?'❌':'ℹ️'}</span><span class="message-text">${text}</span>`;message.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#10b981':type==='error'?'#ef4444':'#3b82f6'};color:white;padding:15px 20px;border-radius:10px;box-shadow:var(--shadow-heavy);z-index:10000;display:flex;align-items:center;gap:10px;transform:translateX(100%);transition:transform 0.3s ease;font-weight:500;`;document.body.appendChild(message);requestAnimationFrame(()=>{message.style.transform='translateX(0)';});setTimeout(()=>{message.style.transform='translateX(100%)';setTimeout(()=>{document.body.removeChild(message);},300);},3000);}}

const themeManager=new ThemeManager();const modalManager=new ModalManager();

document.addEventListener('DOMContentLoaded',function(){const initSupabase=()=>{if(window.supabase&&typeof initializeSupabase==='function'){const success=initializeSupabase();if(success){console.log('✅ Database connection ready');if(window.DatabaseHelper){window.DatabaseHelper.testConnection();}}else{console.error('❌ Failed to initialize Supabase');}}else{setTimeout(initSupabase,100);}};initSupabase();});

const style=document.createElement('style');style.textContent=`@keyframes inputShake{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-5px);}20%,40%,60%,80%{transform:translateX(5px);}}.form-input.error{border-color:#dc3545 !important;box-shadow:0 0 0 0.2rem rgba(220,53,69,0.25) !important;}.form-input.success{border-color:#28a745 !important;box-shadow:0 0 0 0.2rem rgba(40,167,69,0.25) !important;}.error-message{animation:fadeInError 0.3s ease-in-out;}@keyframes fadeInError{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}`;document.head.appendChild(style);
})();